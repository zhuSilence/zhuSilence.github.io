---
layout: post
title: FFmpegè§†é¢‘è§£ç ç®€å•ä½¿ç”¨
date: 2017-01-12
tag: FFmpeg
---

è¿™å‘¨ä¸»è¦åœ¨è§£å†³è§†é¢‘è½¬ç çš„é—®é¢˜ï¼Œå…¶å®žåŽŸæœ¬ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œåªæ˜¯å› ä¸ºå‡ºçŽ°äº†éƒ¨åˆ†å¼€æœºè§†é¢‘æ–‡ä»¶åœ¨éƒ¨åˆ†æœºå™¨ä¸Šå¡æ­»ä¸èƒ½æ­£å¸¸æ’­æ”¾çš„é—®é¢˜ï¼Œå¯¼è‡´äº†å¤–é¢ä¸€å¤§æ‰¹æœºå™¨æ­»æœºã€‚å¯¹äºŽä¸€ä¸ªåšäº’è”ç½‘ç”µè§†çš„å…¬å¸æ¥è¯´ï¼Œç”µè§†æ­»æœºé‚£æ˜¯è‡´å‘½çš„ã€‚æ‰€ä»¥æœ€è¿‘æ‰è¦ä¸¥æ ¼é™åˆ¶è§†é¢‘æ ¼å¼ä»¥åŠè¿›è¡Œä¸»åŠ¨è½¬ç æµ‹è¯•éªŒè¯ï¼Œç¡®ä¿å®Œå…¨æ²¡é—®é¢˜çš„è§†é¢‘æ–‡ä»¶ï¼Œæ‰èƒ½è¿›è¡ŒæŠ•æ”¾ã€‚

ffmpegæ˜¯ä¸€æ¬¾å…è´¹çš„ï¼Œé«˜æ•ˆçš„è§†é¢‘è½¬ç å·¥å…·ï¼Œç½‘ä¸Šå…³äºŽffmpegçš„ä½¿ç”¨æœ‰å¾ˆå¤šçš„ä»‹ç»ï¼Œè¿™é‡Œæˆ‘å°±ä¸æäº†ï¼ˆä¸»è¦æ˜¯æˆ‘ä¹Ÿä¸çŸ¥é“ã€‚ã€‚ã€‚(*@Î¿@*)ï½ž ðŸ˜ï¼‰ï¼Œå¯ä»¥å‚è€ƒ [é›·ç¥ž](http://blog.csdn.net/leixiaohua1020/article/details/12751349) çš„æŠ€æœ¯åšå®¢ã€‚*å¤©å¦’è‹±æ‰ï¼Œå¸Œæœ›å¤©å ‚æ²¡æœ‰ä»£ç ï¼Œé›·ç¥žèµ°å¥½ã€‚*

è¿™æ¬¡çš„è½¬ç å·¥å…·æ˜¯Linuxç³»ç»Ÿä¸‹çš„shè„šæœ¬ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªéƒ¨åˆ†

1ã€åŸºæœ¬é…ç½®

åŸºæœ¬é…ç½®ä¸»è¦æ ¹æ®é¡¹ç›®çš„å®žé™…éœ€æ±‚é…ç½®ç›¸åº”çš„å‚æ•°ï¼Œæ¯”å¦‚å¸§çŽ‡ï¼Œæ¯”ç‰¹çŽ‡ï¼Œåˆ†è¾¨çŽ‡ï¼Œæ—¶é•¿ï¼Œé‡‡æ ·çŽ‡ï¼Œå£°é“ã€‚ã€‚ã€‚å…·ä½“æ•°æ®å°±ä¸å¯¹å¤–å…¬å¸ƒäº†ã€‚

2ã€æ‰§è¡Œå‘½ä»¤

```
echo "--------------------------------------"
echo "intput file         : "${infile}
echo "output file         : "${outfile}
echo "output file format  : "${outFormat}
echo "duration limit      : "${durationLimit}
echo "video mode          : "${videoMode}
echo "video codec         : "${videoCodec}
echo "video profile       : "${videoProfile}
echo "video level         : "${videoLevel}
echo "video bitrate       : "${videoBitRate}
echo "video Frame rate    : "${videoFrameRate}
echo "video resolution    : "${videoResolution}
echo "video aspect ration : "${videoAspectRation}
echo "video ref frames    : "${videoRefFrame}
echo "audio codec         : "${audioCodec}
echo "audio profile       : "${audioProfile}
echo "audio sampling rate : "${audioSamplingRate}
echo "audio channels      : "${audioChannels}
echo "--------------------------------------"
command="./ffmpeg -i "${1}" -c:v "${videoCodec}" "${videoMode}" -refs "${videoRefFrame}" -b-pyramid none -profile:v "${videoProfile}" -level "${videoLevel}" -b:v "${videoBitRate}" -r "${videoFrameRate}" -s "${videoResolution}" -aspect "${videoAspectRation}" -c:a "${audioCodec}" -profile:a "${audioProfile}" -ar "${audioSamplingRate}"  -ac "${audioChannels}" -t "${durationLimit}" -f "${outFormat}" "${2}" -y"
```

é€šè¿‡ä»¥ä¸Šæ–¹æ³•è½¬ç åŽä½¿ç”¨MediaInfoè½¯ä»¶è¿›è¡Œè§†é¢‘ä¿¡æ¯çš„æŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°è§†é¢‘ä¿¡æ¯å‚æ•°å€¼éƒ½æ˜¯è½¬ç åŽçš„å€¼äº†ã€‚ffmpegçš„åŠŸèƒ½éžå¸¸å¼ºå¤§ï¼Œè¿™é‡Œä½¿ç”¨çš„è„šæœ¬æ˜¯åŒ—äº¬åˆ†å…¬å¸é‚£è¾¹æä¾›çš„ï¼Œåœ¨è¿›è¡Œéƒ¨åˆ†ä¿®æ”¹è¿‡åŽå¯ä»¥è¾¾åˆ°æˆ‘ä»¬éœ€è¦çš„è¦æ±‚ã€‚

---

ä¸Šé¢çš„shellè„šæœ¬å¯ä»¥æ ¹æ®æŒ‡å®šå‚æ•°è¿›è¡Œè§†é¢‘çš„è½¬ç ï¼Œä½†æ˜¯æœ‰ä¸ªå°é—®é¢˜ï¼Œå°±æ˜¯æ¯æ¬¡åªèƒ½è½¬ç ä¸€ä¸ªè§†é¢‘ï¼Œåœ¨è§†é¢‘èµ„æºå¾ˆå¤šçš„æƒ…å†µä¸‹ã€‚ã€‚ã€‚è¿™å°†æ˜¯ä¸ªæµ©å¤§çš„å·¥ç¨‹ã€‚æ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šæˆ‘å†™äº†ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬ï¼Œå›žå¤´åªè¦æ‰§è¡Œè¿™ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬å°±å¯ä»¥ä¸€æ¬¡æ€§è½¬ç å¤šä¸ªè§†é¢‘ã€‚è¿™ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠè½¬ç å‰æ–‡ä»¶å¤¹é‡Œé¢çš„è§†é¢‘æ–‡ä»¶è¿›è¡ŒéåŽ†è½¬ç ï¼Œç„¶åŽå­˜æ”¾åˆ°è½¬ç åŽçš„æ–‡ä»¶å¤¹é‡Œé¢ï¼Œå›žå¤´åªè¦å°†éœ€è¦è½¬ç çš„è§†é¢‘æ‹·è´åˆ°è½¬ç å‰æ–‡ä»¶å¤¹é‡Œé¢ï¼Œè¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬å°±å¯ä»¥äº†ã€‚ç”±äºŽè¿™ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬æ˜¯æˆ‘è‡ªå·±å†™çš„ã€‚ã€‚æ‰€ä»¥å°±å¯ä»¥ç®€å•ç²—æš´çš„ç›´æŽ¥ä¸Šä»£ç äº†ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚

```
#!/bin/sh
OLD_IFS=$IFS
IFS=$'\n'
videoResolution=1920x1080
audio=
function checkVideo()
{
   for line in `cat ../temp.txt`
   do
    #æ—¶é•¿
    if [[ $line =~ "Duration" ]];then
	echo $line >> string.txt
	dura=`awk -F"," '{print $1}' string.txt | awk -F":" '{print ($4+0)}'`
	rm -rf string.txt
	if [ `expr "$dura" \< 15.1` -eq 0 ];then
	  echo "---------->è§†é¢‘æ—¶é—´è¶…å‡º15ç§’..."
	  exit 1
	else
	   echo "---------->è§†é¢‘æ—¶é•¿ä¸º${dura}"
	fi
     fi
     #åˆ†è¾¨çŽ‡
     if [[ $line =~ "Video" ]];then
	IFS=","
	array=($line)
	IFS=$'\n'
	for i in ${array[@]}
	 do
	  if [[ $i =~ "1920x1080" ]];then
	    videoResolution=1920x1080
      	  elif [[ $i =~ "1280x720" ]];then
	   videoResolution=1280x720
	  fi
	done
      fi
     #éŸ³é¢‘aacåˆ¤æ–­
     if [[ $line =~ "Audio" ]];then
	echo $line >> string.txt
	audio=`awk -F":" '{print $4}' string.txt`
	rm -rf string.txt
	if [[ $audio =~ "aac" ]];then
	   audio="aac"
	else
	   echo "---------->éŸ³é¢‘æ ¼å¼é”™è¯¯ï¼Œåº”ä¸ºaac..."
	   exit 1
	fi
     fi
     done
}

cd ./aftertrans
echo "---------->æ­£åœ¨æ¸…é™¤aftertransç›®å½•çš„æ•°æ®..."
rm -rf after_*
echo "---------->æ•°æ®æ¸…é™¤å®Œæˆ..."
cd ../beforetrans
echo "---------->è¿›å…¥beforetransç›®å½•..."
rm -rf string.txt
echo "---------->å³å°†å¼€å§‹éåŽ†æ–‡ä»¶è¿›è¡Œè½¬ç æ“ä½œ..."
for file in `ls`
 do
   temp_file=`basename $file`
   echo "---------->è¾“å…¥æ–‡ä»¶:$temp_file"
   echo "---------->è¾“å‡ºæ–‡ä»¶:./aftertrans/after_$temp_file"
   echo "---------->å½“å‰æ£€æµ‹æ–‡ä»¶:$temp_file "
   ~/transcode-tools/ffmpeg -i $temp_file &> ../temp.txt
   echo "---------->å³å°†å¯¹$temp_file å¼€å§‹æ£€æµ‹..."
   checkVideo
   echo "---------->$temp_file æ£€æµ‹å®Œæˆ...å³å°†è¿›è¡Œè½¬ç "
   echo "---------->"
   echo "------->"
   echo "---->"
   #echo "~/aftertrans/after_`date +%Y%m%d%H%M%S`_$temp_file"
   ~/transcode-tools/transcode_2.sh ~/beforetrans/$temp_file "~/aftertrans/after_`date +%Y%m%d%H%M%S`_$temp_file" $videoResolution
   echo "---------->$temp_file è½¬ç å®Œæˆäº†..."
   echo "------->"
   echo "---->"
 done
```


